<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸ§² CERN AEgIS Mission: 2D Edition</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --bg: #fdfdfd; --accent: #0074d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hud { display: grid; grid-template-columns: 1fr 1.5fr 1fr; background: #eee; padding: 10px 30px; border-bottom: 2px solid #ccc; align-items: center; }
        .main-content { display: grid; grid-template-columns: 1fr 380px; flex: 1; overflow: hidden; gap: 10px; padding: 10px; }
        .plots { display: grid; grid-template-rows: 1fr 1fr; gap: 10px; overflow: hidden; }
        #plot2D, #plotAxial { background: white; border: 1px solid #ddd; border-radius: 8px; }
        .controls { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; overflow-y: auto; }
        .coil-item { margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        input[type=range] { width: 100%; cursor: pointer; }
    </style>
</head>
<body>

    <div class="hud">
        <button id="startBtn" onclick="beginMission()" style="padding:10px; font-weight:bold; background:#2ecc40; color:white; border:none; border-radius:5px; cursor:pointer;">ðŸš€ START MISSION</button>
        <div id="scoreLabel" style="font-size:28px; font-weight:bold; text-align:center;">MATCH: 0.0%</div>
        <div id="timerLabel" style="font-size:28px; font-weight:bold; text-align:right; color:red;">TIME: 60s</div>
    </div>

    <div class="main-content">
        <div class="plots">
            <div id="plot2D"></div>
            <div id="plotAxial"></div>
        </div>
        <div class="controls" id="coil-list">
            <h3 style="margin:0 0 10px 0;">Coil Controls</h3>
        </div>
    </div>

<script>
let magnetData = null;
let currents = {};
let timeLeft = 0;

fetch('magnet_data.json')
    .then(res => res.json())
    .then(data => {
        magnetData = data;
        setupUI();
        refresh();
    });

function setupUI() {
    const list = document.getElementById('coil-list');
    Object.keys(magnetData.coils1D).sort().forEach(name => {
        currents[name] = 0;
        let div = document.createElement('div');
        div.className = 'coil-item';
        div.innerHTML = `<div style="display:flex; justify-content:space-between; font-size:12px;"><b>${name}</b><span id="amp_${name}">0 A</span></div>
                         <input type="range" min="0" max="200" value="0" oninput="updateCurrent('${name}', this.value)">`;
        list.appendChild(div);
    });
}

function updateCurrent(name, val) {
    currents[name] = parseFloat(val);
    document.getElementById(`amp_${name}`).innerText = val + " A";
    refresh();
}

function refresh() {
    if (!magnetData) return;
    const z = magnetData.z_axial;
    const yArr = magnetData.y_coords;
    const zArr = magnetData.z_coords;
    
    let liveBz = new Array(z.length).fill(0);
    let live2D = Array.from({length: yArr.length}, () => new Array(zArr.length).fill(0));

    // Superposition Logic
    for (let name in currents) {
        let amp = currents[name];
        if (amp > 0) {
            // 1D
            magnetData.coils1D[name].forEach((v, i) => liveBz[i] += v * amp);
            // 2D
            magnetData.coils2D[name].forEach((row, r) => {
                row.forEach((v, c) => live2D[r][c] += v * amp);
            });
        }
    }

    // Scoring (3.3x Difficulty)
    let err = 0;
    const peak = Math.max(...magnetData.target.map(Math.abs));
    z.forEach((_, i) => err += Math.abs(magnetData.target[i] - liveBz[i]));
    let match = Math.max(0, 100 * (1 - ((err / z.length) / peak * 3.3)));
    document.getElementById('scoreLabel').innerText = `MATCH: ${match.toFixed(1)}%`;

    // Render 1D
    Plotly.react('plotAxial', [
        { x: z, y: magnetData.target, name: 'Goal', line: {color:'#888', width:6} },
        { x: z, y: liveBz, name: 'Live', line: {color:'#0074d9', width:2} }
    ], { title: 'Axial Profile (Bz)', margin:{t:40, b:40, l:50, r:20} });

    

    // Render 2D Contour
    Plotly.react('plot2D', [{
        z: live2D, x: zArr, y: yArr, type: 'heatmap', colorscale: 'Turbo',
        colorbar: {title: 'B [T]', titleside: 'right'}
    }], { title: '2D Magnetic Map (Magnitude)', margin:{t:40, b:40, l:50, r:20} });
}

function beginMission() {
    timeLeft = 60;
    document.getElementById('startBtn').disabled = true;
    let timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timerLabel').innerText = `TIME: ${timeLeft}s`;
        if (timeLeft <= 0) { clearInterval(timer); alert("Mission Complete!"); document.getElementById('startBtn').disabled = false; }
    }, 1000);
}
</script>
</body>
</html>