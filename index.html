<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸ§² CERN AEgIS: TRAP_MAINFRAME_v7.0.0</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --accent: #00ff41; --panel: #161b22; --text: #00ff41; --danger: #ff3131; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100vh; font-family: 'Courier New', monospace; background: #000; color: var(--text); overflow: hidden; }

        /* --- SCREENS --- */
        #bootScreen, #briefingScreen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2500; }
        #briefingScreen { display: none; padding: 40px; }
        #gameInterface { display: none; height: 100vh; width: 100vw; flex-direction: column; }

        /* --- BOOT INPUT --- */
        .boot-input { background: #000; border: 1px solid var(--accent); color: var(--accent); padding: 10px; width: 250px; text-align: center; margin-bottom: 20px; outline: none; text-transform: uppercase; }
        
        /* --- HUD --- */
        .hud { display: grid; grid-template-columns: 180px 1fr 1fr 180px; background: #000; padding: 0 20px; border-bottom: 2px solid #333; align-items: center; height: 55px; flex-shrink: 0; }
        #startBtn { padding: 8px 16px; background: #111; color: var(--accent); border: 2px solid var(--accent); cursor: pointer; text-transform: uppercase; font-size: 11px; font-weight: bold; }
        #startBtn:disabled { color: #444; border-color: #222; cursor: not-allowed; }
        .score { font-size: 22px; font-weight: bold; text-align: center; color: #fff; text-shadow: 0 0 10px var(--accent); }
        .timer { font-size: 24px; color: var(--danger); font-weight: bold; text-align: right; }
        
        /* Global High Score Banner */
        .high-score-banner { font-size: 10px; color: #fff; background: rgba(0,255,65,0.1); padding: 2px 10px; border: 1px solid #333; border-radius: 10px; }

        /* --- LAYOUT --- */
        .main-content { display: flex; flex-grow: 1; gap: 8px; padding: 8px; background: #080a0f; min-height: 0; overflow: hidden; }
        .plots { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 0; }
        .plot-wrapper { flex: 1; min-height: 0; background: #000; border: 1px solid #333; position: relative; border-radius: 4px; overflow: hidden; }
        #particleCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        .card { width: 420px; background: var(--panel); border: 1px solid #30363d; padding: 12px; display: flex; flex-direction: column; min-height: 0; }
        #coil-list { overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 6px; }
        .coil-item { padding: 6px; background: #0d1117; border: 1px solid #222; border-radius: 3px; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: #222; height: 4px; outline: none; }
        input[type=range]:disabled { opacity: 0.2; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 10px; background: var(--accent); cursor: pointer; }

        .shake-crisis { animation: shake 0.05s infinite; border: 10px solid var(--danger) !important; }
        @keyframes shake { 0%{transform:translate(0,0)} 25%{transform:translate(-5px,5px)} 50%{transform:translate(5px,-5px)} 100%{transform:translate(0,0)} }
        .terminal-log { width: 100%; max-width: 600px; height: 300px; border: 1px solid var(--accent); padding: 20px; font-size: 12px; line-height: 1.5; }
        .ready-btn { padding: 12px 30px; background: #000; color: var(--accent); border: 2px solid var(--accent); cursor: pointer; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body id="mainBody">

    <div id="bootScreen">
        <h1 style="color:var(--accent); font-size: 20px; margin-bottom: 30px;">&gt; AEgIS_MAINFRAME_AUTH</h1>
        <input type="text" id="operatorInput" class="boot-input" placeholder="ENTER OPERATOR ID" maxlength="12">
        <button class="ready-btn" onclick="masterUnlock()">ENGAGE MAGNETS</button>
    </div>

    <div id="briefingScreen">
        <div class="terminal-log" id="logContainer"></div>
        <button id="accessBtn" class="ready-btn" style="margin-top:20px; display:none;" onclick="enterLab()">INITIALIZE TERMINAL</button>
    </div>

    <div id="gameInterface">
        <audio id="bgMusic" loop><source src="track1.mp3" type="audio/mpeg"></audio>
        <div class="hud">
            <div style="display:flex; flex-direction:column; gap:4px;">
                <button onclick="beginMission()" id="startBtn">INITIALIZE</button>
                <div id="topScoreDisplay" class="high-score-banner">TOP OP: --- | 0.0%</div>
            </div>
            <div class="score" id="scoreLabel">STABILITY: 0.0%</div>
            <div style="font-size:10px; color:#666; text-align:center;">
                VOL <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.04" oninput="updateMusicVol(this.value)" style="width:60px; vertical-align:middle;" disabled>
                <div id="activeUser" style="color:var(--accent); margin-top:4px;">OP: UNKNOWN</div>
            </div>
            <div class="timer" id="timerLabel">100s</div>
        </div>

        <div class="main-content">
            <div class="plots">
                <div class="plot-wrapper">
                    <div id="plot2D" style="height:100%; width:100%;"></div>
                    <canvas id="particleCanvas"></canvas>
                </div>
                <div class="plot-wrapper"><div id="plot1D" style="height:100%; width:100%;"></div></div>
            </div>
            <div class="card">
                <select id="missionSelect" onchange="toggleMission()" style="background:#000; color:var(--accent); border:1px solid #333; width:100%; padding:4px; margin-bottom:10px; font-size:10px;" disabled>
                    <option value="aegis">AEgIS_STABILIZATION</option>
                    <option value="random">GHOST_MODE (CLICK PLOT)</option>
                </select>
                <div id="coil-list"></div>
            </div>
        </div>
    </div>

<script>
let magnetData = null, currents = {}, timeLeft = 0, timerId = null, curMatch = 0, isSystemActive = false;
let audioCtx = null, magnetHum = null, humGain = null, particles = [], operatorName = "OPERATOR";
let currentTarget = [], isRandom = false;

function masterUnlock() {
    const input = document.getElementById('operatorInput').value;
    operatorName = input.trim() !== "" ? input.toUpperCase() : "OPERATOR";
    document.getElementById('activeUser').innerText = "OP: " + operatorName;
    
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById('bootScreen').style.display = 'none';
    document.getElementById('briefingScreen').style.display = 'flex';
    updateTopScoreDisplay();

    const log = document.getElementById('logContainer');
    const msgs = ["Verifying Credentials...", `Welcome, ${operatorName}.`, "Handshaking with AD Hall...", "Cryo levels: 4.2K (OK)", "Awaiting Manual Initialization..."];
    msgs.forEach((m, i) => {
        setTimeout(() => {
            let d = document.createElement('div'); d.innerText=`> ${m}`; log.appendChild(d);
            if(i===msgs.length-1) document.getElementById('accessBtn').style.display='block';
        }, i*400);
    });
}

function updateTopScoreDisplay() {
    let top = JSON.parse(localStorage.getItem('aegisTop') || '{"name":"NONE","score":0}');
    document.getElementById('topScoreDisplay').innerText = `TOP OP: ${top.name} | ${top.score.toFixed(1)}%`;
}

function enterLab() {
    document.getElementById('briefingScreen').style.display = 'none';
    document.getElementById('gameInterface').style.display = 'flex';
    document.getElementById('bgMusic').play();
    fetch('magnet_data.json').then(r => r.json()).then(data => {
        magnetData = data; 
        currentTarget = [...data.target];
        initUI(); initParticles(); update(); animate();
        document.getElementById('plot1D').on('plotly_click', () => { if(isRandom && isSystemActive) generateGhostField(); });
    });
}

function initUI() {
    const list = document.getElementById('coil-list');
    const ck = magnetData.coils1D ? 'coils1D' : 'coils';
    Object.keys(magnetData[ck]).sort((a,b) => (parseInt(a.match(/\d+/))||0) - (parseInt(b.match(/\d+/))||0)).forEach(name => {
        currents[name] = 0;
        let div = document.createElement('div'); div.className = 'coil-item';
        div.innerHTML = `<div style="display:flex; justify-content:space-between; font-size:9px;"><span>COIL ${name.match(/\d+/)}</span><span id="label_${name}">0.0A</span></div>
                         <input type="range" class="magnet-slider" id="slider_${name}" min="0" max="200" step="0.1" value="0" oninput="setPower('${name}',this.value)" disabled>`;
        list.appendChild(div);
    });
}

function setPower(name, val) { 
    if(!isSystemActive) return;
    currents[name] = parseFloat(val); 
    document.getElementById(`label_${name}`).innerText = val + "A"; 
    update(); 
}

function update() {
    if (!magnetData) return;
    const zk = magnetData.z_axial ? 'z_axial' : 'z';
    let bz1D = new Array(magnetData[zk].length).fill(0);
    let bmag2D = Array.from({length: magnetData.y_grid.length}, () => new Array(magnetData.z_grid.length).fill(0));
    let allZero = Object.values(currents).every(v => v === 0);

    for (let name in currents) {
        let I = currents[name]; if (I <= 0) continue;
        magnetData.coils1D[name].forEach((v, i) => bz1D[i] += v * I);
        magnetData.coils2D[name].forEach((row, r) => row.forEach((v, c) => bmag2D[r][c] += v * I));
    }

    if (allZero) { curMatch = 0; }
    else {
        let sumSqErr = 0; const peak = Math.max(...currentTarget.map(Math.abs)) || 1;
        magnetData[zk].forEach((_, i) => {
            let diff = currentTarget[i] - bz1D[i];
            sumSqErr += diff * diff;
        });
        curMatch = Math.max(0, 100 * (1 - (Math.sqrt(sumSqErr / magnetData[zk].length) / (peak * 0.35))));
    }
    document.getElementById('scoreLabel').innerText = `STABILITY: ${curMatch.toFixed(1)}%`;

    const common = { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41', size:9}, margin:{t:35,b:40,l:55,r:60} };
    Plotly.react('plot1D', [{ x: magnetData[zk], y: currentTarget, line:{dash:'dot', color:'#333', width:2}}, { x: magnetData[zk], y: bz1D, line:{color:curMatch>95?'#00ff41':'#ff3131'}}], { ...common, xaxis:{title:'Axial Z (mm)', gridcolor:'#111'}, yaxis:{title:'B (T)', gridcolor:'#111'} });
    Plotly.react('plot2D', [{ z: bmag2D, x: magnetData.z_grid, y: magnetData.y_grid, type: 'heatmap', colorscale: curMatch > 90 ? 'Viridis' : 'Hot', showscale: true, colorbar: {title: 'B (T)', tickfont: {color:'#00ff41'}} }], { ...common, xaxis:{title:'Z-Axis', gridcolor:'#111'}, yaxis:{title:'Radial R', gridcolor:'#111'} });
}

function beginMission() {
    isSystemActive = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('missionSelect').disabled = false;
    document.getElementById('volSlider').disabled = false;
    document.querySelectorAll('.magnet-slider').forEach(s => s.disabled = false);

    if (!magnetHum) {
        magnetHum = audioCtx.createOscillator(); humGain = audioCtx.createGain();
        magnetHum.type = 'sawtooth'; magnetHum.frequency.setValueAtTime(30, audioCtx.currentTime);
        humGain.gain.setValueAtTime(0, audioCtx.currentTime);
        humGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
        magnetHum.connect(humGain); humGain.connect(audioCtx.destination); magnetHum.start();
    }
    
    timeLeft = 100;
    timerId = setInterval(() => {
        timeLeft--;
        document.getElementById('timerLabel').innerText = timeLeft + "s";
        if (timeLeft <= 10 && curMatch < 30) document.body.classList.add('shake-crisis');
        else document.body.classList.remove('shake-crisis');
        
        if (timeLeft <= 0) {
            clearInterval(timerId);
            document.body.classList.remove('shake-crisis');
            isSystemActive = false;
            document.querySelectorAll('.magnet-slider').forEach(s => s.disabled = true);
            document.getElementById('startBtn').disabled = false;
            if (humGain) humGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.5);
            checkHighScore(curMatch);
            alert("STABILITY LOGGED: " + curMatch.toFixed(1) + "%");
        }
    }, 1000);
}

function checkHighScore(s) {
    let top = JSON.parse(localStorage.getItem('aegisTop') || '{"name":"NONE","score":0}');
    if (s > top.score) {
        localStorage.setItem('aegisTop', JSON.stringify({"name": operatorName, "score": s}));
        updateTopScoreDisplay();
    }
}

function generateGhostField() {
    if(!isSystemActive) return;
    resetCoils();
    let ghost = new Array(magnetData.z_axial.length).fill(0);
    Object.keys(magnetData.coils1D).forEach(k => { if(Math.random() > 0.6) { let amp = Math.random() * 140; magnetData.coils1D[k].forEach((v,i) => ghost[i] += v * amp); } });
    currentTarget = ghost; update();
}

function resetCoils() { for (let name in currents) { currents[name] = 0; if(document.getElementById(`slider_${name}`)) document.getElementById(`slider_${name}`).value = 0; if(document.getElementById(`label_${name}`)) document.getElementById(`label_${name}`).innerText = "0.0A"; } }

function toggleMission() { if(!isSystemActive) return; isRandom = (document.getElementById('missionSelect').value === 'random'); resetCoils(); if (isRandom) generateGhostField(); else currentTarget = [...magnetData.target]; update(); }

function initParticles() { const pc = document.getElementById('particleCanvas'); pc.width = pc.offsetWidth; pc.height = pc.offsetHeight; particles = Array.from({length: 60}, () => ({ x: Math.random() * pc.width, y: pc.height/2, vx: (Math.random()-0.5)*3, vy: 0 })); }

function animate() {
    const pc = document.getElementById('particleCanvas'); if(!pc) return;
    const pCtx = pc.getContext('2d');
    pCtx.clearRect(0,0,pc.width,pc.height);
    particles.forEach(p => {
        p.x += p.vx;
        if(curMatch > 95) p.y += (pc.height/2 - p.y) * 0.15;
        else p.y += (Math.random()-0.5) * 6;
        if(p.x > pc.width) p.x = 0; if(p.x < 0) p.x = pc.width;
        pCtx.fillStyle = curMatch > 95 ? "#00ff41" : "#ff3131";
        pCtx.beginPath(); pCtx.arc(p.x, p.y, 2, 0, Math.PI*2); pCtx.fill();
    });
    requestAnimationFrame(animate);
}

function updateMusicVol(v) { document.getElementById('bgMusic').volume = v; }
</script>
</body>
</html>