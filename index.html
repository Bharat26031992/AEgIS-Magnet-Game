<!DOCTYPE html>
<html>
<head>
    <title>AEgIS Mission: 2D Heatmap Edition</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #fdfdfd; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hud { display: grid; grid-template-columns: 1fr 1fr 1fr; background: #eee; padding: 15px; border-bottom: 2px solid #ccc; align-items: center; }
        .main { display: grid; grid-template-columns: 1fr 380px; flex: 1; overflow: hidden; gap: 10px; padding: 10px; }
        .plots { display: grid; grid-template-rows: 1.2fr 1fr; gap: 10px; }
        #plot2D, #plot1D { background: white; border: 1px solid #ddd; border-radius: 8px; height: 100%; }
        .controls { background: white; border: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        input[type=range] { width: 100%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="hud">
        <button onclick="startMission()" id="startBtn" style="padding:10px; background:#2ecc40; color:white; border:none; border-radius:5px; cursor:pointer;">ðŸš€ START MISSION</button>
        <div id="scoreLabel" style="font-size:24px; font-weight:bold; text-align:center;">MATCH: 0.0%</div>
        <div id="timerLabel" style="font-size:24px; font-weight:bold; text-align:right; color:red;">60s</div>
    </div>

    <div class="main">
        <div class="plots">
            <div id="plot2D"></div>
            <div id="plot1D"></div>
        </div>
        <div class="controls" id="coil-panel">
            <h3 style="margin-top:0">Magnet Supplies</h3>
        </div>
    </div>

<script>
let magnetData = null;
let currents = {};
let timeLeft = 0;

fetch('magnet_data.json')
    .then(res => res.json())
    .then(data => {
        magnetData = data;
        initUI();
        update();
    })
    .catch(err => alert("Error: magnet_data.json is missing 2D data keys!"));

function initUI() {
    const panel = document.getElementById('coil-panel');
    Object.keys(magnetData.coils1D).sort().forEach(name => {
        currents[name] = 0;
        let div = document.createElement('div');
        div.innerHTML = `<div style="display:flex; justify-content:space-between; font-size:12px; margin-top:10px"><b>${name}</b><span id="amp_${name}">0 A</span></div>
                         <input type="range" min="0" max="200" value="0" oninput="setI('${name}', this.value)">`;
        panel.appendChild(div);
    });
}

function setI(name, val) {
    currents[name] = parseFloat(val);
    document.getElementById(`amp_${name}`).innerText = val + " A";
    update();
}

function update() {
    if (!magnetData) return;
    const zAxial = magnetData.z_axial;
    let bz1D = new Array(zAxial.length).fill(0);
    
    // Initialize empty 2D matrix
    let bmag2D = Array.from({length: magnetData.y_grid.length}, () => 
                 new Array(magnetData.z_grid.length).fill(0));

    // Calculate superposition for both 1D and 2D
    for (let name in currents) {
        let I = currents[name];
        if (I > 0) {
            // Update 1D Axial
            magnetData.coils1D[name].forEach((v, i) => bz1D[i] += v * I);
            // Update 2D Heatmap
            magnetData.coils2D[name].forEach((row, r) => {
                row.forEach((v, c) => bmag2D[r][c] += v * I);
            });
        }
    }

    // Scoring logic
    let err = 0;
    const peak = Math.max(...magnetData.target.map(Math.abs));
    zAxial.forEach((_, i) => err += Math.abs(magnetData.target[i] - bz1D[i]));
    let match = Math.max(0, 100 * (1 - ((err / zAxial.length) / peak * 3.3)));
    document.getElementById('scoreLabel').innerText = `MATCH: ${match.toFixed(1)}%`;

    // Render 1D Plot
    Plotly.react('plot1D', [
        { x: zAxial, y: magnetData.target, name: 'Goal', line: {color:'#888', width:6} },
        { x: zAxial, y: bz1D, name: 'Live', line: {color:'#0074d9', width:2} }
    ], { title: 'Axial Profile (Bz)', margin: {t:40, b:40, l:50, r:20} });

    // Render 2D Heatmap
    Plotly.react('plot2D', [{
        z: bmag2D, 
        x: magnetData.z_grid, 
        y: magnetData.y_grid, 
        type: 'heatmap', 
        colorscale: 'Turbo',
        zsmooth: 'best'
    }], { 
        title: '2D Magnetic Map (Magnitude)', 
        margin: {t:40, b:40, l:50, r:20},
        xaxis: {title: 'Z [mm]'},
        yaxis: {title: 'Y [mm]'}
    });
}

function startMission() {
    timeLeft = 60;
    document.getElementById('startBtn').disabled = true;
    let clock = setInterval(() => {
        timeLeft--;
        document.getElementById('timerLabel').innerText = timeLeft + "s";
        if (timeLeft <= 0) { clearInterval(clock); document.getElementById('startBtn').disabled = false; }
    }, 1000);
}
</script>
</body>
</html>