<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸ§² CERN AEgIS: TRAP_CHAOS_OF_THE_AD_HALL</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --accent: #00ff41; --panel: #161b22; --text: #00ff41; --danger: #ff3131; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100vh; font-family: 'Courier New', monospace; background: #000; color: var(--text); overflow: hidden; transition: background 0.2s; }

        /* --- SCREENS --- */
        #bootScreen, #briefingScreen, #performanceScreen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2500; }
        #briefingScreen, #performanceScreen { display: none; padding: 40px; }
        #gameInterface { display: none; height: 100vh; width: 100vw; flex-direction: column; }

        /* --- CRT & ALERT EFFECTS --- */
        .scanline { width: 100%; height: 2px; background: rgba(0, 255, 65, 0.05); position: absolute; top: 0; left: 0; z-index: 3000; pointer-events: none; animation: scan 4s linear infinite; }
        @keyframes scan { from { top: 0; } to { top: 100%; } }
        .critical-alert { animation: redFlash 1s infinite; background: rgba(255, 0, 0, 0.05) !important; }
        @keyframes redFlash { 0%, 100% { box-shadow: inset 0 0 0px var(--danger); } 50% { box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.3); } }
        .shake-active { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(-4px, 4px); } 50% { transform: translate(4px, -4px); } 75% { transform: translate(-4px, -4px); } 100% { transform: translate(0,0); } }

        /* --- LOGO --- */
        .logo-container { margin-bottom: 20px; position: relative; width: 80px; height: 80px; }
        .ring { position: absolute; border: 2px solid var(--accent); border-radius: 50%; width: 100%; height: 100%; animation: pulse 2s ease-in-out infinite; }
        .core { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--accent); }
        @keyframes pulse { 0%, 100% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 1; } }

        /* --- UI COMPONENTS --- */
        .hud { display: grid; grid-template-columns: 200px 1fr 1fr 200px; background: #000; padding: 0 20px; border-bottom: 2px solid #333; align-items: center; height: 55px; flex-shrink: 0; }
        #startBtn { padding: 8px 16px; background: #111; color: var(--accent); border: 2px solid var(--accent); cursor: pointer; text-transform: uppercase; font-size: 11px; font-weight: bold; }
        .score { font-size: 22px; font-weight: bold; text-align: center; color: #fff; text-shadow: 0 0 10px var(--accent); }
        .timer { font-size: 24px; color: var(--danger); font-weight: bold; text-align: right; }

        .main-content { display: flex; flex-grow: 1; gap: 8px; padding: 8px; background: #080a0f; min-height: 0; overflow: hidden; }
        .plots-container { display: flex; flex-direction: column; flex: 1; gap: 8px; }
        .plot-row { display: flex; flex: 1; gap: 8px; min-height: 0; }
        .plot-wrapper { flex: 1; min-height: 0; background: #000; border: 1px solid #333; position: relative; border-radius: 4px; overflow: hidden; }
        #particleCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        .card { width: 350px; background: var(--panel); border: 1px solid #30363d; padding: 12px; display: flex; flex-direction: column; min-height: 0; }
        #coil-list { overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 6px; padding-right: 5px; }
        #coil-list::-webkit-scrollbar { width: 4px; }
        #coil-list::-webkit-scrollbar-thumb { background: #444; }

        .terminal-log { width: 100%; max-width: 700px; min-height: 380px; border: 1px solid var(--accent); padding: 30px; font-size: 13px; line-height: 1.6; background: #050805; box-shadow: 0 0 20px rgba(0,255,65,0.2); }
        .ready-btn { padding: 12px 30px; background: #000; color: var(--accent); border: 2px solid var(--accent); cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 10px;}
    </style>
</head>
<body id="mainBody">

    <div class="scanline"></div>

    <div id="bootScreen">
        <div class="logo-container"><div class="ring"></div><div class="core"></div></div>
        <h1 style="color:var(--accent); font-size: 18px; margin-bottom: 20px;">&gt; AEgIS_MAGNETS_CHAOS_OF_THE_AD_HALL</h1>
        <input type="text" id="operatorInput" style="background:#000; border:1px solid #00ff41; color:#00ff41; padding:10px; width:300px; text-align:center; margin-bottom:15px; outline:none;" placeholder="OPERATOR ID">
        <select id="bootMissionSelect" style="background:#000; border:1px solid #00ff41; color:#00ff41; padding:10px; width:300px; margin-bottom:15px; outline:none;">
            <option value="aegis">MODE: STANDARD_STABILIZATION</option>
            <option value="random">MODE: GHOST_FIELD_CHALLENGE</option>
        </select>
        <button class="ready-btn" onclick="masterUnlock()">ENGAGE MAGNETS</button>
    </div>

    <div id="briefingScreen">
        <div class="logo-container" style="transform: scale(0.6);"><div class="ring" style="animation-duration: 0.5s;"></div><div class="core"></div></div>
        <div class="terminal-log" id="logContainer"></div>
        <button id="accessBtn" class="ready-btn" style="display:none;" onclick="enterLab()">INITIALIZE TERMINAL</button>
    </div>

    <div id="performanceScreen">
        <div class="terminal-log" id="perfContainer"></div>
        <button class="ready-btn" onclick="location.reload()">RE-CALIBRATE</button>
    </div>

    <div id="gameInterface">
        <div class="hud">
            <div><button onclick="beginMission()" id="startBtn">INITIALIZE</button></div>
            <div class="score" id="scoreLabel">STABILITY: 0.0%</div>
            <div style="font-size:10px; text-align:center;"><div id="activeUser">OP: ---</div></div>
            <div class="timer" id="timerLabel">100s</div>
        </div>
        <div class="main-content">
            <div class="plots-container">
                <div class="plot-row">
                    <div class="plot-wrapper">
                        <div id="plot2D" style="height:100%; width:100%;"></div>
                        <canvas id="particleCanvas"></canvas>
                    </div>
                </div>
                <div class="plot-row">
                    <div class="plot-wrapper"><div id="plot1D" style="height:100%; width:100%;"></div></div>
                    <div class="plot-wrapper"><div id="plotGrad" style="height:100%; width:100%;"></div></div>
                </div>
            </div>
            <div class="card"><div id="coil-list"></div></div>
        </div>
    </div>

<script>
let magnetData = null, currents = {}, timeLeft = 0, timerId = null, curMatch = 0, isSystemActive = false;
let audioCtx = null, magnetHum = null, humGain = null, particles = [], operatorName = "OPERATOR";
let currentTarget = [], isRandom = false;

function masterUnlock() {
    operatorName = document.getElementById('operatorInput').value || "OPERATOR";
    isRandom = document.getElementById('bootMissionSelect').value === 'random';
    document.getElementById('activeUser').innerText = "OP: " + operatorName;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    document.getElementById('bootScreen').style.display = 'none';
    document.getElementById('briefingScreen').style.display = 'flex';
    const log = document.getElementById('logContainer');
    
    // New Gritty Technical Messages
    const msgs = [
        "&gt; Dumping liquid nitrogen into the server rack. It's fine. Probably.",
        "&gt; Overriding the safety interlocks on Sector 7. Ignorance is bliss.",
        "&gt; Recalibrating shims. The previous operator used tape. Why is there tape here?",
        "&gt; Attempting to find a reference frame that doesn't involve absolute chaos.",
        "&gt; Diverting 500kW to the magnets. Hope the local grid enjoys the dip.",
        "&gt; Locking particle axis (R=0). The antiprotons are vibrating with malicious intent.",
        "&gt; Cryo stable at 4.2K. Don't touch the pipework unless you want to become part of the experiment.",
        "&gt; Interface online. Don't quench the magnets. We can't afford the helium."
    ];

    msgs.forEach((m, i) => { 
        setTimeout(() => { 
            let d = document.createElement('div'); 
            d.innerHTML = m; 
            log.appendChild(d); 
            if(i === msgs.length - 1) document.getElementById('accessBtn').style.display = 'block'; 
        }, i * 600); 
    });
}

function enterLab() {
    document.getElementById('briefingScreen').style.display = 'none';
    document.getElementById('gameInterface').style.display = 'flex';
    fetch('magnet_data.json').then(r => r.json()).then(data => {
        magnetData = data; 
        if(isRandom) generateGhostField(); else currentTarget = [...data.target];
        initUI(); initParticles(); update(); animate();
    });
}

function initUI() {
    const list = document.getElementById('coil-list');
    Object.keys(magnetData.coils1D).sort((a,b) => (parseInt(a.match(/\d+/))||0) - (parseInt(b.match(/\d+/))||0)).forEach(name => {
        currents[name] = 0;
        let div = document.createElement('div'); div.className = 'coil-item';
        div.innerHTML = `<div style="display:flex; justify-content:space-between; font-size:9px;"><span>COIL ${name.match(/\d+/)}</span><span id="label_${name}">0.0A</span></div>
                         <input type="range" class="magnet-slider" id="slider_${name}" min="0" max="200" step="0.1" value="0" oninput="setPower('${name}',this.value)" disabled>`;
        list.appendChild(div);
    });
}

function setPower(name, val) { 
    if(!isSystemActive) return;
    currents[name] = parseFloat(val); 
    document.getElementById(`label_${name}`).innerText = val + "A"; 
    update(); 
}

function update() {
    if (!magnetData) return;
    const zk = magnetData.z_axial ? 'z_axial' : 'z';
    let bz1D = new Array(magnetData[zk].length).fill(0), gradLive = new Array(magnetData[zk].length).fill(0);
    let bmag2D = Array.from({length: magnetData.y_grid.length}, () => new Array(magnetData.z_grid.length).fill(0));
    for (let name in currents) {
        let I = currents[name]; if (I <= 0) continue;
        magnetData.coils1D[name].forEach((v, i) => bz1D[i] += v * I);
        magnetData.coils2D[name].forEach((row, r) => row.forEach((v, c) => bmag2D[r][c] += v * I));
    }
    for(let i=1; i < bz1D.length; i++) { gradLive[i] = (bz1D[i] - bz1D[i-1]) / (magnetData[zk][i] - magnetData[zk][i-1]); }
    if (Object.values(currents).every(v => v === 0)) curMatch = 0;
    else {
        let sumSqErr = 0; const peak = Math.max(...currentTarget.map(Math.abs)) || 1;
        magnetData[zk].forEach((_, i) => { let diff = currentTarget[i] - bz1D[i]; sumSqErr += diff * diff; });
        curMatch = Math.max(0, 100 * (1 - (Math.sqrt(sumSqErr / magnetData[zk].length) / (peak * 0.35))));
    }
    document.getElementById('scoreLabel').innerText = `STABILITY: ${curMatch.toFixed(1)}%`;
    const common = { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41', size:9}, margin:{t:30,b:40,l:50,r:30} };
    Plotly.react('plot1D', [{ x: magnetData[zk], y: currentTarget, line:{dash:'dot', color:'#333', width:2}}, { x: magnetData[zk], y: bz1D, line:{color:curMatch>95?'#00ff41':'#ff3131'}}], { ...common, xaxis:{title:'Z (mm)', gridcolor:'#111'}, yaxis:{title:'B (T)', gridcolor:'#111'} });
    Plotly.react('plotGrad', [{ x: magnetData[zk], y: gradLive, line:{color:curMatch>95?'#00ff41':'#ff9900'}, fill:'tozeroy'}], { ...common, xaxis:{title:'Z (mm)', gridcolor:'#111'}, yaxis:{title:'dB/dz', gridcolor:'#111'} });
    Plotly.react('plot2D', [{ z: bmag2D, x: magnetData.z_grid, y: magnetData.y_grid, type: 'heatmap', colorscale: curMatch > 90 ? 'Viridis' : 'Hot', showscale: true, colorbar:{title:'B(T)', tickfont:{color:'#00ff41'}} }], { ...common, xaxis:{title:'Z (mm)', gridcolor:'#111'}, yaxis:{title:'Radial R (mm)', gridcolor:'#111'} });
}

function triggerBeep(freq) {
    let osc = audioCtx.createOscillator(); let g = audioCtx.createGain();
    osc.type = 'sine'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
    osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

function beginMission() {
    isSystemActive = true; document.getElementById('startBtn').disabled = true;
    document.querySelectorAll('.magnet-slider').forEach(s => s.disabled = false);
    if (!magnetHum) {
        magnetHum = audioCtx.createOscillator(); humGain = audioCtx.createGain();
        magnetHum.type = 'sawtooth'; magnetHum.frequency.setValueAtTime(30, audioCtx.currentTime);
        humGain.gain.setValueAtTime(0, audioCtx.currentTime); humGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
        magnetHum.connect(humGain); humGain.connect(audioCtx.destination); magnetHum.start();
    }
    timeLeft = 100;
    timerId = setInterval(() => {
        timeLeft--; document.getElementById('timerLabel').innerText = timeLeft + "s";
        if (timeLeft <= 10) {
            triggerBeep(timeLeft === 0 ? 1200 : 800);
            if (curMatch < 30) document.body.classList.add('shake-active', 'critical-alert');
            else document.body.classList.remove('shake-active', 'critical-alert');
        }
        if (timeLeft <= 0) endGame();
    }, 1000);
}

function endGame() {
    clearInterval(timerId); document.body.classList.remove('shake-active', 'critical-alert');
    isSystemActive = false; document.querySelectorAll('.magnet-slider').forEach(s => s.disabled = true);
    if (humGain) humGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.5);
    document.getElementById('gameInterface').style.display = 'none';
    document.getElementById('performanceScreen').style.display = 'flex';
    const container = document.getElementById('perfContainer');
    
    // Performance Reports
    let report = ["&gt; LOG_ENTRY: SHIFT_TERMINATED", `&gt; OPERATOR_ID: ${operatorName}`, `&gt; PEAK_STABILITY: ${curMatch.toFixed(2)}%`];
    if(curMatch > 95) report.push("&gt; STATUS: IMPRESSIVE. The antiprotons are actually behaving for once.");
    else report.push("&gt; STATUS: TOTAL SYSTEM QUENCH. Evacuate the sector immediately.");
    
    container.innerHTML = report.join("<br>");
}

function generateGhostField() {
    let ghost = new Array(magnetData.z_axial.length).fill(0);
    Object.keys(magnetData.coils1D).forEach(k => { if(Math.random() > 0.6) { let amp = Math.random() * 140; magnetData.coils1D[k].forEach((v,i) => ghost[i] += v * amp); } });
    currentTarget = ghost; update();
}

function initParticles() { 
    const pc = document.getElementById('particleCanvas'); pc.width = pc.offsetWidth; pc.height = pc.offsetHeight; 
    particles = Array.from({length: 80}, () => ({ x: Math.random() * pc.width, y: pc.height/2, vx: (Math.random()-0.5)*3 })); 
}

function animate() {
    const pc = document.getElementById('particleCanvas'); if(!pc) return;
    const pCtx = pc.getContext('2d'); pCtx.clearRect(0,0,pc.width,pc.height);
    const radialCenter = pc.height / 2; // R=0 alignment
    particles.forEach(p => {
        p.x += p.vx;
        if(curMatch > 95) p.y += (radialCenter - p.y) * 0.25;
        else p.y += (Math.random()-0.5) * (8 - (curMatch/15)) + (radialCenter - p.y) * 0.05;
        if(p.x > pc.width) p.x = 0; if(p.x < 0) p.x = pc.width;
        pCtx.fillStyle = curMatch >= 95 ? "#00ff41" : (curMatch > 70 ? "#ff9900" : "#ff3131");
        pCtx.beginPath(); pCtx.arc(p.x, p.y, 1.5, 0, Math.PI*2); pCtx.fill();
    });
    requestAnimationFrame(animate);
}
</script>
</body>
</html>