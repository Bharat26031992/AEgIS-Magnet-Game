<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸ§² CERN AEgIS: TRAP_MAINFRAME_v4.0</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --accent: #00ff41; --panel: #161b22; --text: #00ff41; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        @keyframes shake { 0%{transform:translate(0)} 25%{transform:translate(-3px,3px)} 50%{transform:translate(3px,-3px)} 100%{transform:translate(0)} }
        .glitch-active { animation: shake 0.1s infinite; border: 2px solid #ff3131 !important; }

        .hud { display: grid; grid-template-columns: 1fr 1.5fr 1fr; background: #000; padding: 15px 30px; border-bottom: 2px solid var(--accent); align-items: center; z-index: 100; }
        #startBtn { padding: 12px 24px; font-weight: bold; background: var(--accent); color: #000; border: none; cursor: pointer; text-transform: uppercase; }
        #startBtn:disabled { background: #333; color: #666; cursor: not-allowed; }
        .score { font-size: 32px; font-weight: bold; text-align: center; text-shadow: 0 0 10px var(--accent); }
        .timer { font-size: 32px; color: #ff3131; font-weight: bold; text-align: right; }

        .main-content { display: grid; grid-template-columns: 1fr 350px 300px; flex: 1; overflow: hidden; gap: 10px; padding: 10px; background: #000; }
        .plots { display: grid; grid-template-rows: 1.2fr 1fr; gap: 10px; overflow: hidden; }
        
        .plot-container { position: relative; width: 100%; height: 100%; }
        #plot2D { width: 100%; height: 100%; z-index: 1; }
        #particleCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        .card { background: var(--panel); border: 1px solid var(--accent); border-radius: 4px; padding: 15px; overflow-y: auto; }
        .controls h3, .leaderboard h3 { margin: 0 0 10px 0; border-bottom: 1px solid var(--accent); padding-bottom: 8px; font-size: 16px; text-transform: uppercase; }
        .coil-item { margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .coil-info { display: flex; justify-content: space-between; font-size: 12px; }
        input[type=range] { width: 100%; cursor: pointer; filter: hue-rotate(90deg); }

        #leaderboard-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        #leaderboard-table td { padding: 8px 5px; border-bottom: 1px solid #333; }

        #introModal, #reportModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-body { background: #000; border: 2px solid var(--accent); padding: 40px; text-align: center; max-width: 650px; width: 90%; box-shadow: 0 0 20px var(--accent); }
        .ready-btn { margin-top: 20px; padding: 15px 40px; background: var(--accent); color: #000; border: none; cursor: pointer; font-weight: bold; }
        .funny-msg { color: #888; font-style: italic; font-size: 14px; margin-bottom: 20px; min-height: 40px; }
    </style>
</head>
<body>

    <div id="introModal">
        <div class="modal-body">
            <h2>&gt; SYSTEM_BOOT_SEQUENCE</h2>
            <p id="bootQuip" class="funny-msg"></p>
            <p>1D Axial Confinement Protocol Enabled.</p>
            <p><strong>GOAL:</strong> Maintain stability at <strong>90%+</strong>. Failure results in a very polite but firm letter from CERN HR.</p>
            <button class="ready-btn" onclick="initAudio(); document.getElementById('introModal').style.display='none'">ENGAGE MAGNETS (CAREFULLY)</button>
        </div>
    </div>

    <div id="reportModal" style="display:none;">
        <div class="modal-body">
            <h2>&gt; MISSION_DEBRIEF</h2>
            <p id="reportMsg" style="font-size: 18px; line-height: 1.5; margin: 20px 0;"></p>
            <div id="reportGraph" style="height:250px;"></div>
            <button class="ready-btn" onclick="location.reload()">RE-INITIALIZE HARDWARE</button>
        </div>
    </div>

    <div class="hud">
        <button onclick="beginMission()" id="startBtn">INITIALIZE</button>
        <div class="score" id="scoreLabel">STABILITY: 0.0%</div>
        <div class="timer" id="timerLabel">60s</div>
    </div>

    <div class="main-content">
        <div class="plots">
            <div class="plot-container card">
                <div id="plot2D"></div>
                <canvas id="particleCanvas"></canvas>
            </div>
            <div id="plot1D" class="card"></div>
        </div>
        <div class="card controls">
            <h3>&gt; COIL_ARRAYS</h3>
            <select id="missionSelect" onchange="toggleMission()" style="background:#000; color:var(--accent); border:1px solid var(--accent); width:100%; padding:8px; margin-bottom:15px;">
                <option value="aegis">AEgIS_STABILIZATION</option>
                <option value="random">GHOST_MODE (CLICK PLOT)</option>
            </select>
            <div id="coil-list"></div>
        </div>
        <div class="card leaderboard">
            <h3>&gt; TOP_LEVEL_GEEKS</h3>
            <table id="leaderboard-table"><tbody id="leaderboard-body"></tbody></table>
        </div>
    </div>

<script>
let magnetData = null; let currents = {}; let timeLeft = 0; let timerId = null;
let currentTarget = []; let isRandom = false; let curMatch = 0; let stabilityHistory = [];
let zk = 'z'; let ck = 'coils';

// --- AUDIO SYSTEM ---
let audioCtx = null;
let bgHum = null; 
let alarmOsc = null;

const quips = [
    "Loading budget-grade magnets... Calibrating coffee levels... Warning: Antihydrogen doesn't like your face.",
    "Simulating 'Scientific Breakthrough'... Error: Result is just another PhD thesis. Deleting files to save space.",
    "Cryogenic cooling initiated. Please remove your fingers from the liquid nitrogenâ€”unless you were planning on being a statue today.",
    "Scanning for competent operator... Searching... Searching... Warning: Results inconclusive. Proceeding with low expectations.",
    "Antimatter annihilation imminent. If you see a bright light, please refrain from screaming; itâ€™s bad for the data sensors.",
    "Adjusting magnetic field to 'Maximum Overdrive.' If the building starts vibrating, thatâ€™s just the laws of physics asking for a raise.",
    "Vacuum seal integrity at 99%. The remaining 1% is just hope and duct tape. Good luck.",
    "Bypassing safety protocols... Why? Because clicking 'Yes' to all those warnings was taking too long.",
    "Recalibrating particle sensors. Currently detecting 40% positrons and 60% sheer panic.",
    "Quantum tunnel initialized. Please don't think about cats. Especially dead/alive ones. It makes the math messy."
];

function setRandomQuip() {
    document.getElementById('bootQuip').innerText = `"${quips[Math.floor(Math.random() * quips.length)]}"`;
}

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}

function playSound(type) {
    if (!audioCtx) return;
    initAudio();

    if (type === 'hum') {
        if (bgHum) return; 
        bgHum = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        bgHum.type = 'sawtooth'; 
        bgHum.frequency.setValueAtTime(55, audioCtx.currentTime); 
        g.gain.setValueAtTime(0.02, audioCtx.currentTime); 
        bgHum.connect(g); 
        g.connect(audioCtx.destination);
        bgHum.start();
    } else if (type === 'click') {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.05);
        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.05);
    } else if (type === 'alarm' && !alarmOsc) {
        alarmOsc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        alarmOsc.type = 'square';
        alarmOsc.connect(g); 
        g.connect(audioCtx.destination);
        alarmOsc.start();
        alarmOsc.loopInt = setInterval(() => {
            if (timeLeft <= 0 || curMatch >= 95) {
                if (alarmOsc) { try { alarmOsc.stop(); } catch(e) {} alarmOsc = null; }
                clearInterval(alarmOsc.loopInt);
                return;
            }
            alarmOsc.frequency.setValueAtTime(Math.random() > 0.5 ? 900 : 600, audioCtx.currentTime);
            g.gain.setValueAtTime(0.06, audioCtx.currentTime);
        }, 150);
    }
}

function stopSounds() {
    if (bgHum) { try { bgHum.stop(); } catch(e) {} bgHum = null; }
    if (alarmOsc) { try { alarmOsc.stop(); } catch(e) {} alarmOsc = null; }
}

// --- PARTICLE PHYSICS ENGINE ---
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
let particles = [];

function initParticles() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    particles = [];
    let cy = canvas.height / 2;
    let yMm = magnetData ? (Math.max(...magnetData.y_grid) - Math.min(...magnetData.y_grid)) : 20;
    let threeMmPx = (3 * canvas.height) / yMm;

    for (let i = 0; i < 75; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: cy + (Math.random() - 0.5) * threeMmPx,
            vx: (Math.random() > 0.5 ? 1 : -1) * (3 + Math.random() * 2),
            vy: 0 
        });
    }
}

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!magnetData) return requestAnimationFrame(animateParticles);
    let cy = canvas.height / 2;
    let boundary = canvas.width * 0.12;
    particles.forEach(p => {
        if (curMatch >= 90) {
            if (p.x > canvas.width - boundary || p.x < boundary) p.vx *= -1;
            p.vy = (cy - p.y) * 0.2;
            ctx.fillStyle = "#00ff41";
        } else {
            p.vy += (Math.random() - 0.5) * (1.5 - curMatch/50);
            if (p.x > canvas.width) p.x = 0; if (p.x < 0) p.x = canvas.width;
            ctx.fillStyle = "#ff3131";
        }
        p.x += p.vx; p.y += p.vy;
        if (p.y > canvas.height || p.y < 0) p.y = cy;
        ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(animateParticles);
}

// --- INITIALIZATION ---
setRandomQuip();

fetch('magnet_data.json').then(res => res.json()).then(data => {
    magnetData = data;
    zk = data.z_axial ? 'z_axial' : 'z';
    ck = data.coils1D ? 'coils1D' : 'coils';
    currentTarget = [...data.target];
    initUI(); 
    update(); 
    initParticles(); 
    animateParticles(); 
    displayLeaderboard();

    // GHOST MODE CLICK LISTENER
    const plot1D = document.getElementById('plot1D');
    plot1D.on('plotly_click', function() {
        if (!isRandom) return;
        playSound('click');
        let ghost = new Array(magnetData[zk].length).fill(0);
        const keys = Object.keys(magnetData[ck]);
        for(let j=0; j<4; j++) {
            let k = keys[Math.floor(Math.random() * keys.length)];
            let amp = Math.random() * 150;
            magnetData[ck][k].forEach((v, i) => ghost[i] += v * amp);
        }
        currentTarget = ghost; 
        update();
    });
});

function initUI() {
    const list = document.getElementById('coil-list');
    list.innerHTML = "";
    Object.keys(magnetData[ck]).sort().forEach(name => {
        currents[name] = 0;
        let div = document.createElement('div');
        div.className = 'coil-item';
        div.innerHTML = `<div class="coil-info"><span>${name}</span><span id="label_${name}">0 A</span></div>
                         <input type="range" min="0" max="200" step="0.1" value="0" oninput="setPower('${name}',this.value)">`;
        list.appendChild(div);
    });
}

function setPower(name, val) {
    currents[name] = parseFloat(val);
    document.getElementById(`label_${name}`).innerText = val + " A";
    playSound('click');
    update();
}

function toggleMission() {
    isRandom = (document.getElementById('missionSelect').value === 'random');
    currentTarget = isRandom ? new Array(magnetData[zk].length).fill(0) : [...magnetData.target];
    update();
}

function update() {
    if (!magnetData) return;
    const z = magnetData[zk]; 
    let bz1D = new Array(z.length).fill(0);
    let bmag2D = magnetData.y_grid ? Array.from({length: magnetData.y_grid.length}, () => new Array(magnetData.z_grid.length).fill(0)) : null;
    
    let totalCurrent = 0;
    for (let name in currents) {
        let I = currents[name]; 
        totalCurrent += I;
        if (I <= 0) continue;
        magnetData[ck][name].forEach((v, i) => bz1D[i] += v * I);
        if (bmag2D) magnetData.coils2D[name].forEach((row, r) => row.forEach((v, c) => bmag2D[r][c] += v * I));
    }

    if (totalCurrent < 0.1) {
        curMatch = 0; // Harsher Logic: No power, no stability.
    } else {
        let err = 0; 
        const peak = Math.max(...currentTarget.map(Math.abs)) || 1;
        z.forEach((_, i) => err += Math.abs(currentTarget[i] - bz1D[i]));
        curMatch = Math.max(0, 100 * (1 - ((err / z.length) / peak * 3.3)));
    }
    
    document.getElementById('scoreLabel').innerText = `STABILITY: ${curMatch.toFixed(1)}%`;
    Plotly.react('plot1D', [{ x: z, y: currentTarget, name: 'Goal', line: {color:'#444', width:6} }, { x: z, y: bz1D, name: 'Live', line: {color:'#00ff41', width:2} }], { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41'}, margin:{t:30,b:30,l:40,r:10} });
    if (bmag2D) Plotly.react('plot2D', [{ z: bmag2D, x: magnetData.z_grid, y: magnetData.y_grid, type: 'heatmap', colorscale: 'Greens' }], { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41'}, margin:{t:30,b:30,l:40,r:10} });
}

function beginMission() {
    initAudio();
    playSound('hum');
    timeLeft = 60; stabilityHistory = []; document.getElementById('startBtn').disabled = true;
    timerId = setInterval(() => {
        timeLeft--; stabilityHistory.push(curMatch);
        document.getElementById('timerLabel').innerText = timeLeft + "s";
        if (timeLeft <= 10 && curMatch < 95) { 
            document.body.classList.add('glitch-active'); 
            playSound('alarm'); 
        }
        if (timeLeft <= 0) {
            clearInterval(timerId); 
            stopSounds(); 
            document.body.classList.remove('glitch-active');
            showReport();
            if (curMatch >= 90) {
                let n = prompt(`> SUCCESS. LOG SCIENTIST NAME:`, "RE_SEARCHER");
                if (n) {
                    let sc = JSON.parse(localStorage.getItem('aegisScores') || '[]');
                    sc.push({ name: n, score: curMatch }); sc.sort((a,b) => b.score - a.score);
                    localStorage.setItem('aegisScores', JSON.stringify(sc.slice(0,10))); displayLeaderboard();
                }
            }
            document.getElementById('startBtn').disabled = false;
        }
    }, 1000);
}

function showReport() {
    const reportModal = document.getElementById('reportModal');
    const msgLabel = document.getElementById('reportMsg');
    reportModal.style.display = 'flex';
    
    let result = "";
    if (curMatch < 30) {
        result = "FAILURE: You are a useless scientist. Please return your lab coat and exit via the gift shop.";
    } else if (curMatch < 70) {
        result = "MEDIOCRE: Not a total disaster, but the positrons are bored. Try harder.";
    } else if (curMatch < 90) {
        result = "STABLE-ISH: You're getting there. Still wouldn't trust you with the Large Hadron Collider though.";
    } else {
        result = "LEGENDARY: Trap secured! You've officially earned your 'Physics Wizard' badge.";
    }
    
    msgLabel.innerText = result;
    Plotly.newPlot('reportGraph', [{ x: stabilityHistory.map((_,i)=>i), y: stabilityHistory, fill:'tozeroy', line:{color:'#00ff41'} }], { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41'}, margin:{t:10,b:30,l:40,r:10} });
}

function displayLeaderboard() {
    const scores = JSON.parse(localStorage.getItem('aegisScores') || '[]');
    document.getElementById('leaderboard-body').innerHTML = scores.map((s, i) => `<tr><td style="color:#00ff41; font-weight:bold">${i+1}</td><td>${s.name}</td><td>${s.score.toFixed(1)}%</td></tr>`).join('');
}
window.addEventListener('resize', initParticles);
</script>
</body>
</html>