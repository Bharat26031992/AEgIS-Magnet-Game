<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸ§² CERN AEgIS: ULTIMATE_STABILITY_CONTROL</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --bg: #0b0e14; --accent: #00ff41; --panel: #161b22; --text: #00ff41; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        @keyframes shake { 0%{transform:translate(0)} 25%{transform:translate(-3px,3px)} 50%{transform:translate(3px,-3px)} 100%{transform:translate(0)} }
        .glitch-active { animation: shake 0.1s infinite; border: 2px solid #ff3131 !important; }

        .hud { display: grid; grid-template-columns: 1fr 1.5fr 1fr; background: #000; padding: 15px 30px; border-bottom: 2px solid var(--accent); align-items: center; z-index: 100; }
        #startBtn { padding: 12px 24px; font-weight: bold; background: var(--accent); color: #000; border: none; cursor: pointer; text-transform: uppercase; }
        #startBtn:disabled { background: #333; color: #666; }
        .score { font-size: 32px; font-weight: bold; text-align: center; text-shadow: 0 0 10px var(--accent); }
        .timer { font-size: 32px; color: #ff3131; font-weight: bold; text-align: right; }

        .main-content { display: grid; grid-template-columns: 1fr 350px 300px; flex: 1; overflow: hidden; gap: 10px; padding: 10px; background: #000; }
        .plots { display: grid; grid-template-rows: 1.2fr 1fr; gap: 10px; overflow: hidden; }
        
        .plot-container { position: relative; width: 100%; height: 100%; }
        #plot2D { width: 100%; height: 100%; z-index: 1; }
        #particleCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        .card { background: var(--panel); border: 1px solid var(--accent); border-radius: 4px; padding: 15px; overflow-y: auto; }
        .controls h3, .leaderboard h3 { margin: 0 0 10px 0; border-bottom: 1px solid var(--accent); padding-bottom: 8px; font-size: 16px; text-transform: uppercase; }
        .coil-item { margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .coil-info { display: flex; justify-content: space-between; font-size: 12px; }
        input[type=range] { width: 100%; cursor: pointer; filter: hue-rotate(90deg); }

        #leaderboard-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        #leaderboard-table td { padding: 8px 5px; border-bottom: 1px solid #333; }

        #introModal, #reportModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-body { background: #000; border: 2px solid var(--accent); padding: 40px; text-align: center; max-width: 650px; width: 90%; }
        .ready-btn { margin-top: 20px; padding: 15px 40px; background: var(--accent); color: #000; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body id="game-body">

    <div id="introModal">
        <div class="modal-body">
            <h2>&gt; SYSTEM_INITIALIZED</h2>
            <p><strong>MISSION:</strong> Achieve <strong>90% Stability</strong>. Particles are restricted to <strong>Zero Radial Velocity</strong>.</p>
            <p>For <strong>GHOST MODE</strong>, select the option in the dropdown and <strong>CLICK the bottom graph</strong> to generate a target.</p>
            <button class="ready-btn" onclick="document.getElementById('introModal').style.display='none'">START MISSION</button>
        </div>
    </div>

    <div id="reportModal" style="display:none;">
        <div class="modal-body">
            <h2>&gt; MISSION_REPORT</h2>
            <p id="reportMsg"></p>
            <div id="reportGraph" style="height:250px;"></div>
            <button class="ready-btn" onclick="location.reload()">RE-INIT_SYSTEM</button>
        </div>
    </div>

    <div class="hud">
        <button onclick="beginMission()" id="startBtn">INIT_SEQUENCE</button>
        <div class="score" id="scoreLabel">STABILITY: 0.0%</div>
        <div class="timer" id="timerLabel">60s</div>
    </div>

    <div class="main-content">
        <div class="plots">
            <div class="plot-container card">
                <div id="plot2D"></div>
                <canvas id="particleCanvas"></canvas>
            </div>
            <div id="plot1D" class="card"></div>
        </div>
        <div class="card controls">
            <h3>&gt; MISSION_SELECTOR</h3>
            <select id="missionSelect" onchange="toggleMission()" style="background:#000; color:var(--accent); border:1px solid var(--accent); width:100%; padding:8px; margin-bottom:15px;">
                <option value="aegis">AEgIS_STABILIZATION</option>
                <option value="random">RANDOM_GHOST_MODE</option>
            </select>
            <div id="ghostTip" style="font-size:10px; color:#ff3131; display:none; margin-bottom:10px;">&gt; CLICK AXIAL PLOT TO GENERATE TARGET</div>
            <div id="coil-list"></div>
        </div>
        <div class="card leaderboard">
            <h3>&gt; HALL_OF_FAME</h3>
            <table id="leaderboard-table"><tbody id="leaderboard-body"></tbody></table>
        </div>
    </div>

<script>
let magnetData = null; let currents = {}; let timeLeft = 0; let timerId = null;
let currentTarget = []; let isRandom = false; let curMatch = 0; let stabilityHistory = [];
let zk = 'z'; let ck = 'coils'; // Defaults

// --- PARTICLE ENGINE ---
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
let particles = [];

function initParticles() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    particles = [];
    let cy = canvas.height / 2;
    for (let i = 0; i < 70; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: cy + (Math.random() - 0.5) * (canvas.height * 0.1),
            vx: (Math.random() > 0.5 ? 1 : -1) * (3 + Math.random() * 2),
            vy: 0 
        });
    }
}

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!magnetData) return requestAnimationFrame(animateParticles);
    let cy = canvas.height / 2;
    let mirrorBoundary = canvas.width * 0.12;
    particles.forEach(p => {
        if (curMatch >= 90) {
            if (p.x > canvas.width - mirrorBoundary || p.x < mirrorBoundary) p.vx *= -1;
            p.vy = (cy - p.y) * 0.15;
            ctx.fillStyle = "#00ff41";
        } else {
            p.vy += (Math.random() - 0.5) * (1.5 - curMatch/60);
            if (p.x > canvas.width) p.x = 0; if (p.x < 0) p.x = canvas.width;
            ctx.fillStyle = "#ff3131";
        }
        p.x += p.vx; p.y += p.vy;
        if (p.y > canvas.height || p.y < 0) p.y = cy;
        ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(animateParticles);
}

// --- DATA & SYSTEM ---
fetch('magnet_data.json').then(res => res.json()).then(data => {
    magnetData = data;
    zk = data.z_axial ? 'z_axial' : 'z';
    ck = data.coils1D ? 'coils1D' : 'coils';
    currentTarget = [...data.target];
    initUI();
    update();
    displayLeaderboard();
    initParticles();
    animateParticles();
    setupGhostClick();
});

function initUI() {
    const list = document.getElementById('coil-list');
    list.innerHTML = "";
    Object.keys(magnetData[ck]).sort().forEach(name => {
        currents[name] = 0;
        let div = document.createElement('div');
        div.className = 'coil-item';
        div.innerHTML = `<div class="coil-info"><span>${name}</span><span id="label_${name}">0 A</span></div>
                         <input type="range" min="0" max="200" step="0.1" value="0" oninput="setPower('${name}',this.value)">`;
        list.appendChild(div);
    });
}

function setPower(name, val) {
    currents[name] = parseFloat(val);
    document.getElementById(`label_${name}`).innerText = val + " A";
    update();
}

function toggleMission() {
    isRandom = (document.getElementById('missionSelect').value === 'random');
    document.getElementById('ghostTip').style.display = isRandom ? 'block' : 'none';
    currentTarget = isRandom ? new Array(magnetData[zk].length).fill(0) : [...magnetData.target];
    update();
}

function setupGhostClick() {
    const gd = document.getElementById('plot1D');
    gd.on('plotly_click', function() {
        if (!isRandom) return;
        // Generate a random ghost field based on 4 random coils
        let ghost = new Array(magnetData[zk].length).fill(0);
        const keys = Object.keys(magnetData[ck]);
        for(let j=0; j<4; j++) {
            let k = keys[Math.floor(Math.random() * keys.length)];
            let amp = Math.random() * 150;
            magnetData[ck][k].forEach((v, i) => ghost[i] += v * amp);
        }
        currentTarget = ghost;
        update();
    });
}

function update() {
    if (!magnetData) return;
    const z = magnetData[zk]; 
    let bz1D = new Array(z.length).fill(0);
    let bmag2D = magnetData.y_grid ? Array.from({length: magnetData.y_grid.length}, () => new Array(magnetData.z_grid.length).fill(0)) : null;

    for (let name in currents) {
        let I = currents[name]; if (I <= 0) continue;
        magnetData[ck][name].forEach((v, i) => bz1D[i] += v * I);
        if (bmag2D) magnetData.coils2D[name].forEach((row, r) => row.forEach((v, c) => bmag2D[r][c] += v * I));
    }
    let err = 0; const peak = Math.max(...currentTarget.map(Math.abs)) || 1;
    z.forEach((_, i) => err += Math.abs(currentTarget[i] - bz1D[i]));
    curMatch = Math.max(0, 100 * (1 - ((err / z.length) / peak * 3.3)));
    
    document.getElementById('scoreLabel').innerText = `STABILITY: ${curMatch.toFixed(1)}%`;
    Plotly.react('plot1D', [
        { x: z, y: currentTarget, name: 'Target', line: {color:'#444', width:6} },
        { x: z, y: bz1D, name: 'Live', line: {color:'#00ff41', width:2} }
    ], { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41'}, margin:{t:30,b:30,l:40,r:10}, xaxis:{gridcolor:'#222'}, yaxis:{gridcolor:'#222'} });
    
    if (bmag2D) {
        Plotly.react('plot2D', [{ z: bmag2D, x: magnetData.z_grid, y: magnetData.y_grid, type: 'heatmap', colorscale: 'Greens' }], 
        { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41'}, margin:{t:30,b:30,l:40,r:10} });
    }
}

// --- MISSION TIMER & SOUND ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beginMission() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    timeLeft = 60; stabilityHistory = []; document.getElementById('startBtn').disabled = true;
    timerId = setInterval(() => {
        timeLeft--; stabilityHistory.push(curMatch);
        document.getElementById('timerLabel').innerText = timeLeft + "s";
        if (timeLeft <= 10 && curMatch < 95) document.body.classList.add('glitch-active');
        if (timeLeft <= 0) {
            clearInterval(timerId); document.body.classList.remove('glitch-active');
            showReport();
            if (curMatch >= 90) {
                let n = prompt(`> MISSION SUCCESS. LOG SCIENTIST NAME:`, "RE_SEARCHER");
                if (n) {
                    let sc = JSON.parse(localStorage.getItem('aegisScores') || '[]');
                    sc.push({ name: n, score: curMatch }); sc.sort((a,b) => b.score - a.score);
                    localStorage.setItem('aegisScores', JSON.stringify(sc.slice(0,10))); displayLeaderboard();
                }
            }
            document.getElementById('startBtn').disabled = false;
        }
    }, 1000);
}

function showReport() {
    document.getElementById('reportModal').style.display = 'flex';
    document.getElementById('reportMsg').innerText = curMatch < 30 ? "CRITICAL_FAILURE: Useless Scientist detected." : "MISSION_COMPLETE.";
    Plotly.newPlot('reportGraph', [{ x: stabilityHistory.map((_,i)=>i), y: stabilityHistory, fill:'tozeroy', line:{color:'#00ff41'} }], 
    { paper_bgcolor:'#000', plot_bgcolor:'#000', font:{color:'#00ff41'}, margin:{t:10,b:30,l:40,r:10}, xaxis:{title:'Time'}, yaxis:{title:'%'} });
}

function displayLeaderboard() {
    const scores = JSON.parse(localStorage.getItem('aegisScores') || '[]');
    document.getElementById('leaderboard-body').innerHTML = scores.map((s, i) => `<tr><td style="color:#00ff41; font-weight:bold">${i+1}</td><td>${s.name}</td><td>${s.score.toFixed(1)}%</td></tr>`).join('');
}
</script>
</body>
</html>